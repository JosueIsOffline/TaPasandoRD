{% extends "layout.html.twig" %}

{% block styles %}
{{parent()}}
<style>
  .map{
    height: 400px;  
    display: flex; 
    align-items: center; 
    justify-content: center;
  }
  .toast-message {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 9999;
    background: #38a169;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s, transform 0.4s;
    transform: translateY(-30px);
    font-size: 1rem;
    min-width: 220px;
    max-width: 90vw;
    text-align: center;
}
.toast-message.show {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
}
@media (max-width: 600px) {
    .toast-message {
        right: 50%;
        top: 1rem;
        left: 50%;
        transform: translate(-50%, -30px);
        min-width: 80vw;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
    }
    .toast-message.show {
        transform: translate(-50%, 0);
    }
}
</style>
{% endblock %}

{% block content %}
        {% if message %}
            <div id="toast-message" class="toast-message">
              {{ message }}
            </div>
        {% endif %}
            <div class="container-fluid p-4">
                <div class="row mb-4">
                    <div class="col-12">
                        <h1 class="mb-0">Reportar Incidencia</h1>
                        <p class="text-muted">Registra una nueva incidencia en el sistema</p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="card incident-card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Información de la Incidencia</h5>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="/api/incident">
                                    <input type="hidden" name="reported_by" value={{auth_user().id}} />

                                    <input type="hidden" name="status" value="pendiente" />
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Fecha de Ocurrencia</label>
                                                <input type="datetime-local" class="form-control" name="occurrence_date" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Título</label>
                                                <input type="text" class="form-control" name="title" placeholder="Título descriptivo" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Tipo de Incidencia</label>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" value="1" type="checkbox" name="category_id" id="accidente" required>
                                                    <label class="form-check-label" for="accidente">Accidente de Tráfico</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" value="2" type="checkbox" name="category_id" id="pelea">
                                                    <label class="form-check-label" for="pelea">Inundación</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" value="3" type="checkbox" name="category_id" id="robo">
                                                    <label class="form-check-label" for="robo">Incendio</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" value="4" type="checkbox" name="category_id" id="desastre">
                                                    <label class="form-check-label" for="desastre">Robo</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Descripción</label>
                                        <textarea class="form-control" rows="4" name="description" placeholder="Describe los detalles de la incidencia..." required></textarea>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Provincia</label>
                                                <select class="form-select" name="province_id" required>
                                                    <option value="">Seleccionar provincia</option>
                                                    <option value=1>Distrito Nacional</option>
                                                    <option value=2>Santo Domingo</option>
                                                    <option value=3>Santiago</option>
                                                    <option value=4>La Vega</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Municipio</label>
                                                <select class="form-select" name="municipality_id" required>
                                                    <option value="">Seleccionar municipio</option>
                                                    <option value=1>Santo Domingo Este</option>
                                                    <option value=2>Santo Domingo Norte</option>
                                                    <option value=3>Santo Domingo Oeste</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Barrio</label>
                                                <select class="form-select" name="neighborhood_id" required>
                                                    <option value="">Seleccionar Barrio</option>
                                                    <option value=1>Santo Domingo Ese</option>
                                                    <option value=2>Santo Domingo Norte</option>
                                                    <option value=3>Santo Domingo Oeste</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Latitud</label>
                                                <input type="number" id="latitude" class="form-control" name="latitude" placeholder="18.4861" step="any" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Longitud</label>
                                                <input type="number" id="longitude" class="form-control" name="longitude" placeholder="-69.9312" step="any" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Muertos</label>
                                                <input type="number" class="form-control" name="deaths" placeholder="0" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Heridos</label>
                                                <input type="number" class="form-control" name="injuries" placeholder="0" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Pérdida Estimada</label>
                                                <input type="number" class="form-control" name="estimated_loss" placeholder="0" min="0" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Link a Redes Sociales</label>
                                        <input type="url" class="form-control" name="social_media_url" placeholder="https://...">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Foto del Hecho</label>
                                        <input type="file" class="form-control" name="photo_url" accept="image/*">
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Enviar Reporte
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card incident-card mt-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Seleccionar Ubicación</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="map" id="map">
                                    <!-- <div class="text-center"> -->
                                    <!--     <i class="fas fa-map-marker-alt fa-3x text-primary mb-3"></i> -->
                                    <!--     <p class="text-muted">Haz clic en el mapa para seleccionar la ubicación exacta</p> -->
                                    <!-- </div> -->
                                </div>
                            </div>
                        </div>

                        <div class="card incident-card mt-3">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Información</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Tu reporte será revisado por un validador antes de ser publicado.
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Asegúrate de que toda la información sea veraz y precisa.
                                </div>
                                <div class="alert alert-success">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Haz clic en el mapa para seleccionar la ubicación exacta o ingresa las coordenadas manualmente.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
{% endblock %}

{% block scripts %}
{{parent()}}
  <script>
    var map;
    var marker;
    var latInput = document.getElementById('latitude');
    var lngInput = document.getElementById('longitude');
    
    map = L.map('map').setView([18.7357, -70.1627], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    function updateMarker(lat, lng) {
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        marker.bindPopup(`
            <b>Ubicación Seleccionada</b><br>
            Latitud: ${lat.toFixed(6)}<br>
            Longitud: ${lng.toFixed(6)}
        `).openPopup();
    }
    
    map.on('click', function(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
        
        updateMarker(lat, lng);
    });
    
    function updateMapFromInputs() {
        var lat = parseFloat(latInput.value);
        var lng = parseFloat(lngInput.value);
        
        if (!isNaN(lat) && !isNaN(lng) && 
            lat >= -90 && lat <= 90 && 
            lng >= -180 && lng <= 180) {
            
            map.setView([lat, lng], 13);
            
            updateMarker(lat, lng);
        }
    }
    
    latInput.addEventListener('blur', updateMapFromInputs);
    lngInput.addEventListener('blur', updateMapFromInputs);
    
    latInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            updateMapFromInputs();
        }
    });
    
    lngInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            updateMapFromInputs();
        }
    });
    
    // Función opcional para limpiar la selección
    function clearLocation() {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        latInput.value = '';
        lngInput.value = '';
    } 
  </script>

   {% if message %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var toast = document.getElementById('toast-message');
            if (toast) {
                toast.classList.add('show');
                setTimeout(function() {
                    toast.classList.remove('show');
                }, 3000);
            }
        });
    </script>
    {% endif %}
{% endblock %}
